<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Ø§Ù„Ù…ÙŠØ§Ø­ÙŠ TV - Ø§Ù„Ù…ÙØ·ÙˆÙ‘ÙØ±</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  
  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
  <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
  
  <script src="https://unpkg.com/videojs-http-streaming/dist/videojs-http-streaming.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-dash/2.9.2/videojs-dash.min.js"></script>
  
  <style>
    /* ------------------------------------------- */
    /* ğŸ¨ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„Ù…Ø´ØºÙ„ */
    /* ------------------------------------------- */
    body {
      font-family: 'Cairo', sans-serif;
      background: #000;
      color: #ffd700;
      margin: 0;
      padding: 0;
      text-align: center;
      overflow-x: hidden;
    }
    
    /* ğŸ›¡ï¸ Ø´Ø±ÙŠØ· Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª */
    header {
      padding: 15px;
      background: #111;
      font-size: 24px;
      font-weight: bold;
      color: #ffd700;
      display: flex;
      justify-content: center;
      align-items: center;
      position: sticky; 
      top: 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
      z-index: 20; 
      transition: all 0.3s ease-in-out;
    }
    
    #refresh, #share-btn, #message-close {
      position: absolute;
      background: #ffd700;
      color: #000;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
      z-index: 1;
      font-size: 14px; 
    }
    #refresh:hover, #share-btn:hover, #message-close:hover {
      background: #e5c100;
      transform: scale(1.05);
    }
    #refresh { left: 15px; top: 15px; }
    #share-btn { right: 15px; top: 15px; } 

    /* ğŸ“º ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø´ØºÙ„ */
    .video-js {
      width: 100%;
      max-height: 70vh; 
      background: #000;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.2); 
    }
    
    /* ğŸš€ ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…ÙØ­Ø³Ù‘ÙÙ†Ø© */
    .video-js.vjs-fullscreen, .vjs-user-inactive.vjs-fullscreen { 
        width: 100vw !important;
        height: 100vh !important;
        max-height: 100vh !important;
        position: fixed !important;
        top: 0;
        left: 0;
        z-index: 9999; 
    }
    body.fullscreen-active header, body.fullscreen-active #channels-container {
      opacity: 0; 
      visibility: hidden; 
      transition: opacity 0.4s ease-out, visibility 0.4s;
      pointer-events: none; 
    }
    body.fullscreen-active { overflow: hidden; }

    /* ğŸ’¡ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠØ© (Notification) */
    #system-message-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10000;
        pointer-events: none;
    }
    .system-message {
        font-family: 'Cairo', sans-serif;
        background: rgba(255, 215, 0, 0.95); 
        color: #000;
        padding: 15px 30px;
        border-radius: 12px;
        font-weight: bold;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
        font-size: 22px;
        transition: opacity 0.5s ease;
        opacity: 1;
        pointer-events: auto; 
        position: relative;
    }

    /* ------------------------------------------- */
    /* ğŸ“‘ ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù‚Ù†ÙˆØ§Øª ÙˆØªØ¬Ù…ÙŠØ¹Ù‡Ø§ (Ø§Ù„ØªÙ‚Ø³ÙŠÙ…Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) */
    /* ------------------------------------------- */
    #channels-container {
      background: #181818; 
      padding: 10px;
      text-align: right;
      border-top: 3px solid #ffd700;
      transition: all 0.3s ease-in-out; 
    }
    
    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙØ¦Ø§Øª (Sections) */
    .section-title {
      background: #333;
      color: #ffd700;
      padding: 12px 15px;
      margin-top: 10px;
      font-weight: bold;
      border-radius: 8px;
      text-align: right;
      border-right: 4px solid #ffd700;
      cursor: pointer;
      transition: background 0.3s, border-right-color 0.3s;
      display: flex; 
      justify-content: space-between;
      align-items: center;
    }
    .section-title:hover { background: #444; }
    .section-title.active {
      background: #ffd700;
      color: #000;
      border-right-color: #000;
    }
    .section-arrow {
        transition: transform 0.3s;
        font-size: 1.2em;
        line-height: 1; 
    }
    .section-title.active .section-arrow {
        transform: rotate(90deg); 
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ…Ø±ÙŠØ± */
    .channels-list { 
        display: none; 
        padding: 5px 0 10px 0; 
        max-height: 400px; 
        overflow-y: auto; 
    }
    .channels-list.active { display: block; }
    
    /* ØªÙ†Ø³ÙŠÙ‚ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
    .channels-list::-webkit-scrollbar { width: 8px; }
    .channels-list::-webkit-scrollbar-track { background: #222; border-radius: 10px; }
    .channels-list::-webkit-scrollbar-thumb { background: #ffd700; border-radius: 10px; }
    .channels-list::-webkit-scrollbar-thumb:hover { background: #e5c100; }


    .channel {
      padding: 10px 15px;
      background: #222;
      margin-bottom: 5px;
      border-radius: 8px;
      color: #ffd700;
      cursor: pointer;
      transition: background 0.3s, transform: 0.1s;
      border-right: 4px solid transparent;
      text-align: right;
    }
    .channel:hover { background: #333; transform: translateX(-3px); }
    .channel.active {
      background: #ffd700;
      color: #000;
      font-weight: bold;
      border-right-color: #000;
      box-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
    }

    /* ğŸ”§ ØªØ¹Ø¯ÙŠÙ„Ø§Øª VideoJS */
    .vjs-loading-spinner { border-top-color: #ffd700 !important; }
    .vjs-control-bar { opacity: 1 !important; visibility: visible !important; } 
    
  </style>
</head>
<body>
  <header>
    Ø§Ù„Ù…ÙŠØ§Ø­ÙŠ TV
    <button id="refresh" onclick="PlayerApp.reloadFromM3U()">âŸ³ ØªØ­Ø¯ÙŠØ«</button>
    <button id="share-btn" onclick="shareCurrentLink()">ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©</button>
  </header>
  
  <video id="player" class="video-js vjs-default-skin vjs-big-play-centered" controls playsinline webkit-playsinline preload="auto"></video>

  <div id="channels-container"></div>
  
  <div id="system-message-container"></div> 
  <script>
    let currentPlayingUrl = null;
    let retryCount = 0;
    let currentPlayer = null;

    const PlayerApp = (() => {
      // âš ï¸ Ø±Ø§Ø¨Ø· Ù…Ù„Ù M3U
      const M3U_URL = 'http://raw.githubusercontent.com/Hussain21e/Hwqq/main/bein4k.m3u'; 
      const channelsContainer = document.getElementById('channels-container');
      const playerElement = document.getElementById('player');
      let allChannels = [];
      let currentChannelUrl = null;
      let currentChannelName = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±';

      // ÙˆØ¸ÙŠÙØ© Ù„Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ù†Ø¸Ø§Ù… Ø¹ØµØ±ÙŠØ© ÙˆÙ…Ø¤Ù‚ØªØ©
      const showSystemMessage = (message, duration = 3000) => {
          const container = document.getElementById('system-message-container');
          container.innerHTML = `<div class="system-message">${message}</div>`;
          setTimeout(() => {
              container.innerHTML = '';
          }, duration);
      };
      
      const determineSourceType = url => {
        const lower = url.toLowerCase();
        if (lower.includes('.m3u8')) return 'application/x-mpegURL';
        if (lower.includes('.mpd')) return 'application/dash+xml';
        if (lower.includes('.mp4')) return 'video/mp4';
        return 'application/x-mpegURL';
      };
      
      // ØªØ¬Ø§ÙˆØ² Ø§Ù„ÙƒØ§Ø´ (Cache Busting)
      const getCacheBustedUrl = (url) => {
          const separator = url.includes('?') ? '&' : '?';
          return `${url}${separator}_=${Date.now()}`;
      };
      
      // ğŸ”„ Ù†Ø¸Ø§Ù… Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ù…ØªÙ‚Ø¯Ù… (Exponential Backoff)
      const retryPlay = (isInitialAttempt = false) => {
        if (!currentChannelUrl) return;
        
        if (!navigator.onLine) {
            console.warn("Ø§Ù„Ø´Ø¨ÙƒØ© ØºÙŠØ± Ù…ØªØµÙ„Ø©ØŒ ØªØ£Ø¬ÙŠÙ„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.");
            showSystemMessage('âš ï¸ Ø§Ù„Ø´Ø¨ÙƒØ© ØºÙŠØ± Ù…ØªØµÙ„Ø©. Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...', 5000);
            setTimeout(retryPlay, 5000); 
            return;
        }

        if (isInitialAttempt) {
            retryCount = 0;
        } else {
            retryCount++;
        }
        
        if (retryCount > 10) { // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
            showSystemMessage('âŒ ÙØ´Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.', 10000);
            console.error("ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª.");
            return;
        }

        // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ£Ø®ÙŠØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹ÙˆØ¯Ø© Ø§Ù„Ø£ÙØ³Ù‘ÙŠØ© (Exponential Backoff)
        const delay = Math.min(Math.pow(2, retryCount) * 1000, 15000); // Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 15 Ø«Ø§Ù†ÙŠØ©
        console.log(`Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø±Ù‚Ù… ${retryCount} Ù„Ù‚Ù†Ø§Ø© ${currentChannelName} Ø¨Ø¹Ø¯ ${delay/1000} Ø«ÙˆØ§Ù†ÙŠ...`);
        showSystemMessage(`ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© #${retryCount} Ù„Ù„Ù‚Ù†Ø§Ø©: **${currentChannelName}**`, delay);

        setTimeout(() => {
          const sourceUrl = getCacheBustedUrl(currentChannelUrl); 
          currentPlayer.src({ src: sourceUrl, type: determineSourceType(sourceUrl) }); 
          
          currentPlayer.play().catch(e => {
            console.error("ÙØ´Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©:", e);
            retryPlay(); 
          });
        }, delay);
      };

      const initializePlayer = () => {
        const options = {
          autoplay: true,
          controls: true,
          preload: 'auto', 
          fluid: true, // Ø§Ù„Ù…Ø´ØºÙ„ Ù…ØªØ¬Ø§ÙˆØ¨
          errorDisplay: false, 
          html5: {
            vhs: {
              // âš¡ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù„Ù€ HLS/DASH
              enableLowInitialPlaylist: true, // Ø¨Ø¯Ø¡ Ø³Ø±ÙŠØ¹ Ø¨Ø¯Ù‚Ø© Ù…Ù†Ø®ÙØ¶Ø©
              fastQualityChange: true, // ØªØ³Ø±ÙŠØ¹ ØªØºÙŠÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø©
              overrideNative: true, 
              hlsLogging: false,
              minPlaylistCount: 1, 
              liveSyncDurationCount: 1, // Ø§Ù„Ø¨Ù‚Ø§Ø¡ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
              liveMaxCatchupDuration: 2, // Ø³Ø±Ø¹Ø© Ø§Ù„Ù„Ø­Ø§Ù‚ Ø¨Ø§Ù„Ø¨Ø«
              bandwidth: 1500000, // Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¨Øª Ø§Ù„Ø£ÙˆÙ„ÙŠ (1.5 Ù…ÙŠØ¬Ø§)
              bufferSafety: 3, // ÙƒÙ…ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
            },
          },
          liveui: true,
        };
        
        if (currentPlayer) currentPlayer.dispose();
        
        currentPlayer = videojs(playerElement, options); 

        currentPlayer.on('fullscreenchange', () => {
            if (currentPlayer.isFullscreen()) {
                enterFullscreenLogic();
            } else {
                exitFullscreenLogic();
            }
        });

        currentPlayer.on('playing', () => { 
            retryCount = 0; 
            showSystemMessage(`âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ù†Ø§Ø©: **${currentChannelName}**`, 2000);
        });
        
        currentPlayer.on('error', () => { 
            const error = currentPlayer.error();
            if (!error || error.code === 4) { 
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„ (Ø§Ù„Ø´Ø¨ÙƒØ© Ø£Ùˆ Ø§Ù„ØªØ­Ù…ÙŠÙ„).", error);
                retryPlay(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
            } else {
                console.error("Ø®Ø·Ø£ ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©:", error);
                showSystemMessage(`âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ${error ? error.message : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`, 5000);
            }
        });
        
        currentPlayer.on('waiting', () => {
             showSystemMessage(`â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ù‚Ù†Ø§Ø©: **${currentChannelName}**`, 1500);
        });
      };
      
      // ğŸ“‘ [Ù…ÙØ­Ø³Ù‘ÙÙ†] ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù M3U Ù„Ø¯Ø¹Ù… ## ÙƒØ¹Ù†Ø§ÙˆÙŠÙ† Ø±Ø¦ÙŠØ³ÙŠØ©
      const parseM3U = text => {
        const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
        const groups = [];
        let currentGroupIndex = -1;
        let defaultGroup = { group: 'Ù‚Ù†ÙˆØ§Øª Ù…ØªÙ†ÙˆØ¹Ø©', channels: [] }; 

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          
          // 1. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ØªÙŠ ØªØ¨Ø¯Ø£ Ø¨Ù€ ##
          if (line.startsWith('##')) {
            const groupName = line.substring(2).trim(); 
            groups.push({ group: groupName, channels: [] });
            currentGroupIndex = groups.length - 1;
            continue; 
          }
          
          // 2. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù‚Ù†ÙˆØ§Øª EXTNINF
          if (line.startsWith('#EXTINF')) {
            const nameMatch = line.match(/tvg-name="([^"]+)"/i) || line.match(/,(.*)/);
            let name = (nameMatch?.[1]?.trim() || 'Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©').replace(/['"]+/g, '');
            
            const groupMatch = line.match(/group-title="([^"]+)"/i);
            const groupTitle = groupMatch ? groupMatch[1].trim().replace(/['"]+/g, '') : null;

            const url = lines[i + 1];

            if (url?.startsWith('http')) {
                const channel = { name, url: url.trim() };
                
                if (currentGroupIndex !== -1) {
                    groups[currentGroupIndex].channels.push(channel);
                } else if (groupTitle) {
                    let existingGroup = groups.find(g => g.group === groupTitle);
                    if (!existingGroup) {
                        existingGroup = { group: groupTitle, channels: [] };
                        groups.push(existingGroup);
                    }
                    existingGroup.channels.push(channel);
                }
                else {
                    defaultGroup.channels.push(channel);
                }
                
                i++; // ØªØ®Ø·ÙŠ Ø³Ø·Ø± Ø§Ù„Ù€ URL
            }
          }
        }
        
        if (defaultGroup.channels.length > 0) {
             groups.push(defaultGroup);
        }
        
        return groups; 
      };


      const reloadFromM3U = async () => {
        channelsContainer.innerHTML = ''; 
        showSystemMessage('ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§...', 3000);
        
        try {
          const response = await fetch(getCacheBustedUrl(M3U_URL)); 
          if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ù…Ù„Ù M3U');
          const text = await response.text();
          allChannels = parseM3U(text);
          displayChannels(allChannels);
          
          const firstChannel = allChannels.length > 0 && allChannels[0].channels.length > 0 
                               ? allChannels[0].channels[0] : null;

          if (firstChannel) {
             playChannel(firstChannel.url, firstChannel.name);
          } else {
             showSystemMessage('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù†ÙˆØ§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.', 5000);
          }
          
        } catch (e) {
          console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ M3U:", e);
          channelsContainer.innerHTML = '<div class="message" style="color:#FF6347;padding:20px;">âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ø§Ø¨Ø· M3U Ø£Ùˆ Ø§ØªØµØ§Ù„ Ø§Ù„Ø´Ø¨ÙƒØ©.</div>';
        }
      };

      // ğŸ“‘ Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ù†ÙˆØ§Øª ÙÙŠ ÙØ¦Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø·ÙŠ
      const displayChannels = (groupedChannels) => {
        channelsContainer.innerHTML = '';
        
        groupedChannels.forEach((groupItem, index) => {
            // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ¦Ø©
            const titleDiv = document.createElement('div');
            titleDiv.className = 'section-title';
            // Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ù„Ù„Ø¹Ù†ÙˆÙ†
            titleDiv.innerHTML = `<span>${groupItem.group} (${groupItem.channels.length})</span><span class="section-arrow">â–¶</span>`;
            
            // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ù†ÙˆØ§Øª
            const listDiv = document.createElement('div');
            listDiv.className = 'channels-list';
            
            // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø·ÙŠ ÙˆØ§Ù„ÙØªØ­
            titleDiv.onclick = () => {
                const isActive = listDiv.classList.contains('active');
                // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
                document.querySelectorAll('.channels-list').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('.section-title').forEach(t => t.classList.remove('active'));
                if (!isActive) {
                    listDiv.classList.add('active');
                    titleDiv.classList.add('active');
                }
            };
            
            groupItem.channels.forEach(ch => {
              const div = document.createElement('div');
              div.className = 'channel';
              div.textContent = ch.name;
              div.onclick = () => playChannel(ch.url, ch.name);
              listDiv.appendChild(div);
            });
            
            channelsContainer.appendChild(titleDiv);
            channelsContainer.appendChild(listDiv);
            
            // Ø¬Ø¹Ù„ Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù…ÙØªÙˆØ­Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            if (index === 0) {
                listDiv.classList.add('active');
                titleDiv.classList.add('active');
            }
        });
      };

      const playChannel = (url, name) => {
        currentChannelUrl = url;
        currentPlayingUrl = url;
        currentChannelName = name;
        retryCount = 0; 
        
        showSystemMessage(`ğŸ“¡ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ **${name}**...`, 2500);
        
        if (currentPlayer) {
            currentPlayer.pause();
            currentPlayer.reset(); 
        }
        
        const sourceUrl = getCacheBustedUrl(url); 
        
        currentPlayer.src({ src: sourceUrl, type: determineSourceType(sourceUrl) });
        
        currentPlayer.play().catch(e => {
            console.warn("ÙØ´Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ (Ù‚Ø¯ ÙŠØªØ·Ù„Ø¨ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…).", e);
        });
        
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
        document.querySelectorAll('.channel').forEach(c => c.classList.remove('active'));
        const active = Array.from(document.querySelectorAll('.channel')).find(c => c.textContent === name);
        if (active) active.classList.add('active');
        
        // ØªØºÙŠÙŠØ± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
        document.title = `Ø§Ù„Ù…ÙŠØ§Ø­ÙŠ TV - ${name}`;
      };

      return { init: () => { initializePlayer(); reloadFromM3U(); }, reloadFromM3U, currentChannelName, showSystemMessage };
    })();

    document.addEventListener('DOMContentLoaded', PlayerApp.init);
    
    // ğŸ–¥ï¸ Ù…Ù†Ø·Ù‚ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¬Ù‡Ø§Ø²
    async function enterFullscreenLogic() {
        document.body.classList.add('fullscreen-active');
        if (screen.orientation && screen.orientation.lock) {
          try { 
            await screen.orientation.lock('landscape').catch(() => {}); 
          } catch(e) { 
             console.warn("ÙØ´Ù„ Ù‚ÙÙ„ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡:", e);
          }
        }
    }
    
    function exitFullscreenLogic() {
        document.body.classList.remove('fullscreen-active');
        if (screen.orientation && screen.orientation.unlock) {
            try { screen.orientation.unlock(); } catch(e) { /* ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø®Ø·Ø£ */ }
        }
        document.title = 'Ø§Ù„Ù…ÙŠØ§Ø­ÙŠ TV - Ø§Ù„Ù…ÙØ·ÙˆÙ‘ÙØ±'; 
    }
    
    // ğŸ”— ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø©
    function shareCurrentLink() {
      if (!currentPlayingUrl) { 
          PlayerApp.showSystemMessage('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ù†Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹.', 3000); 
          return;
      }
      if (navigator.share) {
        navigator.share({ title: 'Ø§Ù„Ù…ÙŠØ§Ø­ÙŠ TV', text: `Ø£Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø¢Ù†: ${PlayerApp.currentChannelName}`, url: currentPlayingUrl })
           .then(() => PlayerApp.showSystemMessage('âœ… ØªÙ… Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­.', 2000))
           .catch((error) => console.error('ÙØ´Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©:', error));
      } else {
        navigator.clipboard.writeText(currentPlayingUrl);
        PlayerApp.showSystemMessage('âœ… ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù‚Ù†Ø§Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©.', 2000);
      }
    }
  </script>
</body>
</html>
