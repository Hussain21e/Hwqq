<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Ø§Ù„Ù…ÙŠØ§Ø­ÙŠ TV - Ù…Ø´ØºÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.0/dist/hls.min.js"></script>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #000;
      color: #FFD700;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      padding: 15px;
      background: #111;
      font-size: 24px;
      font-weight: bold;
      color: #FFD700;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    #refresh, #add-channel {
      position: absolute;
      top: 15px;
      background: #FFD700;
      color: #000;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    #refresh { left: 15px; }
    #add-channel { right: 15px; }
    #refresh:hover, #add-channel:hover {
      background: #e5c100;
    }
    video {
      width: 100%;
      height: auto;
      background: #000;
    }
    /* Ø´Ø±ÙŠØ· Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ */
    #player-status {
      color: #FFD700;
      padding: 10px;
      font-size: 18px;
      background: #111;
      min-height: 20px;
    }
    #channels {
      max-height: 300px;
      overflow-y: auto;
      background: #111;
      padding: 10px;
      text-align: right;
    }
    .channel {
      padding: 10px;
      background: #222;
      margin-bottom: 5px;
      border-radius: 8px;
      color: #FFD700;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }
    .channel:hover {
      background: #333;
    }
    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„ØªÙŠ ÙŠØªÙ… ØªØ´ØºÙŠÙ„Ù‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹ */
    .channel.playing {
      background: #FFD700; 
      color: #000;
      border: 2px solid #000;
    }
    .channel.playing .channel-name {
      font-weight: bold;
    }
    .channel.playing .channel-buttons button {
      background: #000;
      color: #FFD700;
    }
    /* Ù†Ù‡Ø§ÙŠØ© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„ØªÙŠ ÙŠØªÙ… ØªØ´ØºÙŠÙ„Ù‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹ */
    .channel-name {
      flex: 1;
      cursor: pointer;
    }
    .channel-buttons button {
      margin-left: 5px;
      background: #FFD700;
      color: #000;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
      font-size: 13px;
    }
    .channel-buttons button:hover {
      background: #e5c100;
    }

    /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
    #modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    #modal .box {
      background: #222;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      color: #FFD700;
    }
    #modal input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      text-align: right;
    }
    #modal button {
      background: #FFD700;
      color: #000;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <header>Ø§Ù„Ù…ÙŠØ§Ø­ÙŠ TV</header>
  <button id="refresh" onclick="reloadFromM3U()">ØªØ­Ø¯ÙŠØ«</button>
  <button id="add-channel" onclick="openModal()">Ø¥Ø¶Ø§ÙØ© Ù‚Ù†Ø§Ø©</button>

  <video id="player" controls autoplay playsinline webkit-playsinline muted crossorigin="anonymous"></video>
  <div id="player-status" dir="rtl">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ù†Ø§Ø© Ù„Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„</div>
  <div id="channels"></div>

  <div id="modal">
    <div class="box">
      <h3 id="modal-title">Ø¥Ø¶Ø§ÙØ© Ù‚Ù†Ø§Ø©</h3>
      <input type="text" id="channel-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©">
      <input type="text" id="channel-url" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù‚Ù†Ø§Ø© (m3u8 Ø£Ùˆ ts)">
      <div style="text-align: left;">
        <button onclick="saveModal()">Ø­ÙØ¸</button>
        <button onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <script>
    const m3uUrl = 'http://raw.githubusercontent.com/Hussain21e/Hwqq/main/bein4k.m3u';
    const channelsContainer = document.getElementById('channels');
    const video = document.getElementById('player');
    const playerStatus = document.getElementById('player-status');
    let hls = null;
    let channels = [];
    let editIndex = null;
    let currentPlayingUrl = null;

    function initVideoAttrs() {
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø®ØµØ§Ø¦Øµ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
      video.setAttribute('playsinline', '');
      video.setAttribute('webkit-playsinline', '');
      video.setAttribute('autoplay', '');
      video.muted = true;
    }

    function parseM3U(text) {
      const lines = text.split(/\r?\n/).map(l => l.trim());
      const parsed = [];
      for (let i = 0; i < lines.length; i++) {
        if (lines[i].startsWith('#EXTINF')) {
          const name = lines[i].split(',')[1] || 'Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©';
          const url = lines[i + 1];
          if (url) parsed.push({ name, url: url.trim() });
        }
      }
      return parsed;
    }

    function saveChannelsToStorage() {
      // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù‡Ù†Ø§ Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
      localStorage.setItem('channels', JSON.stringify(channels));
    }

    /*
    *** ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… loadChannelsFromStorage()
    *** Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø±Ø§Ø¨Ø· M3U
    function loadChannelsFromStorage() {
        // ...
    }
    */

    function reloadFromM3U() {
      channelsContainer.innerHTML = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ù†ÙˆØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...';
      fetch(m3uUrl)
        .then(r => r.text())
        .then(data => {
          channels = parseM3U(data);
          saveChannelsToStorage();
          displayChannels();
          if (channels.length > 0) playChannel(channels[0].url, channels[0].name);
        })
        .catch(() => channelsContainer.innerHTML = 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
    }

    function displayChannels() {
      channelsContainer.innerHTML = '';
      if (channels.length === 0) {
        channelsContainer.innerHTML = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù†ÙˆØ§Øª Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ø¶ØºØ· "Ø¥Ø¶Ø§ÙØ© Ù‚Ù†Ø§Ø©" Ø£Ùˆ "ØªØ­Ø¯ÙŠØ«".';
        return;
      }
      channels.forEach((ch, index) => {
        const div = document.createElement('div');
        div.className = 'channel';

        if (ch.url === currentPlayingUrl) {
            div.classList.add('playing');
        }

        const nameSpan = document.createElement('div');
        nameSpan.className = 'channel-name';
        nameSpan.textContent = ch.name;
        nameSpan.onclick = () => playChannel(ch.url, ch.name);

        const btns = document.createElement('div');
        btns.className = 'channel-buttons';

        const editBtn = document.createElement('button');
        editBtn.textContent = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„';
        editBtn.onclick = (e) => { e.stopPropagation(); openModal(index); };

        const delBtn = document.createElement('button');
        delBtn.textContent = 'ğŸ—‘ Ø­Ø°Ù';
        delBtn.onclick = (e) => { e.stopPropagation(); deleteChannel(index); };

        btns.appendChild(editBtn);
        btns.appendChild(delBtn);
        div.appendChild(nameSpan);
        div.appendChild(btns);
        channelsContainer.appendChild(div);
      });
    }

    function playChannel(url, name = 'Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©') {
      if (!url) return;
      url = url.trim();

      currentPlayingUrl = url;
      playerStatus.textContent = `Ø¬Ø§Ø±ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„: ${name} ...`;
      displayChannels();

      if (hls) { hls.destroy(); hls = null; }

      if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.play().then(() => {
          playerStatus.textContent = `ØªØ´ØºÙŠÙ„: ${name} - (ÙŠØ±Ø¬Ù‰ Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„ØµÙˆØª)`;
          video.muted = false;
        }).catch((e) => {
          playerStatus.textContent = `ØªØ´ØºÙŠÙ„ ØµØ§Ù…Øª: ${name} - (Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³Ù…Ø§Ø¹Ø©)`;
          video.muted = true;
          video.play().catch(()=>{playerStatus.textContent = `Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ù†Ø§Ø© ${name}`;});
        });
      } 
      else if (Hls.isSupported()) {
        hls = new Hls({ autoStartLoad: true, debug: false, enableWorker: false });
        
        hls.on(Hls.Events.ERROR, (event, data) => {
          if (data.fatal) {
            playerStatus.textContent = `Ø®Ø·Ø£ ÙØ§Ø¯Ø­: ÙØ´Ù„ ØªØ´ØºÙŠÙ„ ${name} (${data.type}/${data.reason})`;
            if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
              hls.startLoad();
            } else {
              hls.destroy();
            }
          }
        });

        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          video.play().then(() => {
            playerStatus.textContent = `ØªØ´ØºÙŠÙ„: ${name} - (ÙŠØ±Ø¬Ù‰ Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„ØµÙˆØª)`;
            video.muted = false;
          }).catch((e) => {
            playerStatus.textContent = `ØªØ´ØºÙŠÙ„ ØµØ§Ù…Øª: ${name} - (Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³Ù…Ø§Ø¹Ø©)`;
            video.muted = true;
            video.play().catch(()=>{playerStatus.textContent = `Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ù†Ø§Ø© ${name}`;});
          });
        });
      } else {
        playerStatus.textContent = 'Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ HLS';
      }
    }

    // Modal functions
    function openModal(index = null) {
      editIndex = index;
      document.getElementById('modal-title').textContent = index === null ? 'Ø¥Ø¶Ø§ÙØ© Ù‚Ù†Ø§Ø©' : 'ØªØ¹Ø¯ÙŠÙ„ Ù‚Ù†Ø§Ø©';
      document.getElementById('channel-name').value = index === null ? '' : channels[index].name;
      document.getElementById('channel-url').value = index === null ? '' : channels[index].url;
      document.getElementById('modal').style.display = 'flex';
    }
    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }
    function saveModal() {
      const name = document.getElementById('channel-name').value.trim();
      const url = document.getElementById('channel-url').value.trim();
      if (!name || !url) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆØ±Ø§Ø¨Ø· Ø§Ù„Ù‚Ù†Ø§Ø©'); return; }
      if (editIndex === null) {
        channels.unshift({ name, url });
      } else {
        channels[editIndex] = { name, url };
      }
      saveChannelsToStorage();
      displayChannels();
      closeModal();
    }
    function deleteChannel(index) {
      if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ù†Ø§Ø©ØŸ')) {
        channels.splice(index, 1);
        saveChannelsToStorage();
        displayChannels();
        playerStatus.textContent = 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ù†Ø§Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ù†Ø§Ø© Ø£Ø®Ø±Ù‰.';
      }
    }

    // *** Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù‡Ù†Ø§ ***
    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ØŒ ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ reloadFromM3U() Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ù†ÙˆØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    document.addEventListener('DOMContentLoaded', () => {
      initVideoAttrs();
      reloadFromM3U(); // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ù…Ù† Ø±Ø§Ø¨Ø· M3U Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    });
  </script>
</body>
</html>
